name: (Reusable) Update Major Tag

on:
  workflow_call:
    inputs:
      branch:
        description: 'Branch to set the tag on. The tag will be set on the latest commit.'
        required: true
        type: string
      tag:
        description: 'Git tag to move (e.g., v1).'
        required: true
        type: string
      target-tag:
        description: 'Target tag to point to. If provided, the major tag will point to the same commit as this tag. If empty, it points to the latest commit of the branch.'
        required: false
        type: string
    secrets:
      BOT_APP_ID:
        required: false
      BOT_PRIVATE_KEY:
        required: false
    outputs:
      sha:
        description: 'SHA of the commit where the tag was set'
        value: ${{ jobs.update-major-tag.outputs.sha }}

jobs:
  update-major-tag:
    runs-on: ubuntu-22.04
    outputs:
      sha: ${{ steps.resolve-commit.outputs.sha }}
    steps:
      - name: Check secrets availability
        id: check-secrets
        run: |
          if [ -n "${{ secrets.BOT_APP_ID }}" ] && [ -n "${{ secrets.BOT_PRIVATE_KEY }}" ]; then
            echo "available=1" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate GitHub App Token
        id: app-token
        if: ${{ steps.check-secrets.outputs.available == '1' }}
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          ref: ${{ inputs.branch }}

      - name: Resolve target commit
        id: resolve-commit
        run: |
          NOTICE_MSG="Tag: ${{ inputs.tag }}"
          NOTICE_MSG="${NOTICE_MSG}
          Current Branch/Ref: ${{ inputs.branch }}"
          
          if [ -n "${{ inputs.target-tag }}" ]; then
            NOTICE_MSG="${NOTICE_MSG}
            Target Tag Provided: ${{ inputs.target-tag }}"
          
            # Check if target tag exists
            if git rev-parse "${{ inputs.target-tag }}" >/dev/null 2>&1; then
              TARGET_SHA=$(git rev-parse "${{ inputs.target-tag }}")
              # Checkout to that specific commit so HEAD points to it
              git checkout "$TARGET_SHA"
            else
              echo "::error::Target tag '${{ inputs.target-tag }}' not found!"
              exit 1
            fi
          else
            NOTICE_MSG="${NOTICE_MSG}
            No Target Tag provided, using HEAD of branch"
            TARGET_SHA=$(git rev-parse HEAD)
          fi
          
          NOTICE_MSG="${NOTICE_MSG}
          Target Commit SHA: $TARGET_SHA"
          
          # 改行を %0A に置換して1つのnoticeとして出力
          NOTICE_MSG="${NOTICE_MSG//$'\n'/'%0A'}"
          echo "::notice::$NOTICE_MSG"
          
          git show --summary
          echo "sha=$TARGET_SHA" | tee -a "$GITHUB_OUTPUT"

      - name: Update ${{ inputs.tag }} tag
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'

          git tag -f ${{ inputs.tag }}
          git push origin ${{ inputs.tag }} -f
