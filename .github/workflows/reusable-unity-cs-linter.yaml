name: (Reusable) Unity C# Linter

on:
  workflow_call:
    inputs:
      head-branch:
        description: 'Target head branch for investigation'
        required: false
        type: string
        default: 'HEAD'
      base-branch:
        description: 'Target base branch for investigation'
        required: false
        type: string
        default: ''
      include_paths:
        description: 'Include files or directories (regex, comma-separated). For more information https://www.gnu.org/software/grep/manual/'
        required: false
        type: string
        default: '.*'
      exclude_paths:
        description: 'Exclude files or directories (regex, comma-separated)'
        required: false
        type: string
        default: ''

jobs:
  check-editorconfig:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate .editorconfig file
        run: |
          if [ ! -f .editorconfig ]; then
            echo "::error title=.editorconfig Missing::The root of the repository is missing an .editorconfig file. For reference, you can look at: https://github.com/IShix-g/Unity-GitHubActions/blob/main/.editorconfig"
            exit 1
          else
            echo ".editorconfig file exists at the root of the repository."
          fi

  set-base-branch:
    runs-on: ubuntu-22.04
    outputs: 
      branch: ${{ steps.set-base-branch.outputs.branch }}
    steps:
      - name: Set Base Branch
        id: set-base-branch
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ inputs.base-branch }}" ]; then
            base_branch="${{ inputs.base-branch }}"
          else
            base_branch=$(gh api /repos/${{ github.repository }} --jq '.base_branch')
          fi
          echo "branch=${base_branch#refs/heads/}" >> "$GITHUB_OUTPUT"

          echo "::notice title=Base Branch::$base_branch"
          echo "::notice title=Head Branch::${{ inputs.head-branch }}"

  setup-environment:
    needs: [set-base-branch]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.head-branch }}
          fetch-depth: 0

      - name: Install .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '7.0'

  detect-changed-cs-files:
    needs: [set-base-branch, setup-environment]
    runs-on: ubuntu-22.04
    steps:
      - name: Detect Changed C# Files
        id: detect_cs_files
        run: |
          files=$(git diff --name-only origin/${{ needs.set-base-branch.outputs.branch }}...${{ inputs.head-branch }} | grep '\.cs$' || true)
          if [ -z "$files" ]; then
            echo "No C# files were changed in this PR."
            exit 0
          fi

          include_regexes=$(echo "${{ inputs.include_paths }}" | tr ',' '\n')
          exclude_regexes=$(echo "${{ inputs.exclude_paths }}" | tr ',' '\n')

          included_files=""
          for file in $files; do
            include_matched=false
            exclude_matched=false

            for regex in $include_regexes; do
              if [[ "$file" =~ $regex ]]; then
                include_matched=true
              fi
            done

            for regex in $exclude_regexes; do
              if [[ "$file" =~ $regex ]]; then
                exclude_matched=true
              fi
            done

            if $include_matched && ! $exclude_matched; then
              included_files+="${file}\n"
            fi
          done

          if [ -z "$included_files" ]; then
            echo "No C# files matched the include/exclude criteria."
            exit 0
          fi

          included_files=$(echo -e "$included_files" | sed '/^\s*$/d')
          length=$(echo "$included_files" | wc -l)
          echo "::notice title=Detected changed C# files.::$length files"
          echo "::group::Detected changed C# files."
          echo -e "$included_files"
          echo "::endgroup::"

          echo "files=$(echo -e "$included_files" | tr '\n' ',')" >> "$GITHUB_OUTPUT"
          
  generate-temp-csproj:
    needs: [detect-changed-cs-files]
    if: ${{ needs.detect-changed-cs-files.outputs.files != '' }}
    runs-on: ubuntu-22.04
    steps:
      - name: Create Temporary csproj for Analysis
        run: |
          echo "<Project Sdk=\"Microsoft.NET.Sdk\">" > TempProject.csproj
          echo "  <PropertyGroup>" >> TempProject.csproj
          echo "    <TargetFramework>netstandard2.1</TargetFramework>" >> TempProject.csproj
          echo "    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>" >> TempProject.csproj
          echo "  </PropertyGroup>" >> TempProject.csproj
          echo "</Project>" >> TempProject.csproj

      - name: Update Temporary csproj with Changed Files
        run: |
          echo "Adding modified C# files to TempProject.csproj..."
          sed -i '$d' TempProject.csproj # Remove last line
          echo "  <ItemGroup>" >> TempProject.csproj
          IFS=',' read -ra files <<< "${{ needs.detect-changed-cs-files.outputs.files }}"
          for file in "${files[@]}"; do
            echo "    <Compile Include=\"$file\" />" >> TempProject.csproj
          done
          echo "  </ItemGroup>" >> TempProject.csproj
          echo "</Project>" >> TempProject.csproj

  run-style-check:
    needs: [generate-temp-csproj]
    if: ${{ needs.detect-changed-cs-files.outputs.files != '' }}
    runs-on: ubuntu-22.04
    steps:
      - name: Install StyleCop and dotnet-format
        run: |
          dotnet new tool-manifest
          dotnet tool install dotnet-format
          dotnet add package StyleCop.Analyzers

      - name: Collect Style Violations Log
        run: |
          echo "Collecting style violations into output.log..."
          dotnet format TempProject.csproj --verify-no-changes >> output.log 2>&1 || echo "Style violation detected" >> output.log

  convert-to-sarif-and-review:
    needs: [run-style-check]
    if: ${{ needs.detect-changed-cs-files.outputs.files != '' }}
    runs-on: ubuntu-22.04
    steps:
      - name: Run StyleCop and Convert to SARIF
        run: |
          python3 .github/scripts/convert_to_sarif.py output.log output.sarif

      - name: Setup reviewdog
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest

      - name: Apply Style Suggestions with reviewdog
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          reviewdog -f=sarif \
            -name="StyleCop" \
            -reporter=github-pr-review \
            -filter-mode=file \
            -level=warning \
            -fail-level=error \
            < output.sarif

  cleanup:
    needs: [convert-to-sarif-and-review]
    if: ${{ always() && needs.detect-changed-cs-files.outputs.files != '' }}
    runs-on: ubuntu-22.04
    steps:
      - name: Cleanup temporary files
        run: |
          rm -f TempProject.csproj output.log output.sarif || true