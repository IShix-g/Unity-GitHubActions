name: (Reusable) Check Last Run Status & Age

on:
  workflow_call:
    inputs:
      workflow-id:
        description: 'Workflow ID (filename also acceptable)'
        required: true
        type: string
      min-day:
        description: 'Minimum age in days for workflow run'
        required: true
        type: string
      max-day:
        description: 'Maximum age in days for workflow run'
        required: true
        type: string
    outputs:
      condition:
        description: 'Returns 1 if the specified action last run was successful and within the specified date range'
        value: ${{ jobs.check-status.outputs.condition }}

jobs:
  check-status:
    runs-on: ubuntu-22.04
    outputs:
      condition: ${{ steps.check-conditions.outputs.condition }}
    steps:
      - name: üöÄ Get Latest Workflow Info via API
        id: get-info
        run: |
          api_response=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/${{ inputs.workflow-id }}/runs?per_page=1")
          
          run_info=$(echo "$api_response" | jq -r '.workflow_runs[0]')
          
          updated-at=$(echo "$run_info" | jq -r '.updated_at')
          conclusion=$(echo "$run_info" | jq -r '.conclusion')
          
          echo "Last completed updated-at: $updated-at"
          echo "Last completed conclusion: $conclusion"
          
          echo "updated-at=$updated-at" >> $GITHUB_OUTPUT
          echo "conclusion=$conclusion" >> $GITHUB_OUTPUT
        shell: bash

      - name: üìù Use Retrieved Info and Check Conditions
        id: check-conditions
        if: ${{ steps.get-info.outputs.updated-at != 'null' && steps.get-info.outputs.conclusion != 'null' }}
        run: |
          latestUpdate="${{ steps.get-info.outputs.updated-at }}"
          latestConclusion="${{ steps.get-info.outputs.conclusion }}"
          
          minDay=${{ inputs.min-day }}
          maxDay=${{ inputs.max-day }}
          current_ts=$(date +%s)
          updated_ts=$(date -d "$latestUpdate" +%s)
          
          minSec=$(( minDay * 24 * 60 * 60 ))
          maxSec=$(( maxDay * 24 * 60 * 60 ))
          
          age_secs=$(( current_ts - updated_ts ))
          
          is_success=false
          is_in_range=false
          
          if [ "$latestConclusion" == "success" ]; then
            is_success=true
            echo "‚úÖ Conclusion: success"
          else
            echo "‚ùå Conclusion: $latestConclusion (Not success)"
          fi
          
          if [ $age_secs -ge $minSec ] && [ $age_secs -le $maxSec ]; then
            is_in_range=true
            echo "‚úÖ Date Range: Within $minDay and $maxDay days range."
          else
            echo "‚ùå Date Range: Outside the range ($(( age_secs / 86400 )) days old)."
          fi
          
          if $is_success && $is_in_range; then
            echo "::notice::üéâ All conditions are met!"
            echo "condition=1" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::‚ùå Conditions are not met." 
          fi
        
        shell: bash
