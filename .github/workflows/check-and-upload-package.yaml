name: Check and Upload Package Exporter

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - "Manual Release (Merge to Default)"
      - "Manual Release and Build Package (Merge to Default)"
      - "Release via PR (Default Branch)"
    types:
      - closed

jobs:
  check-package:
    runs-on: ubuntu-22.04
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.pull_request.merged }}
    outputs:
      file-present: ${{ steps.check-file.outputs.file-present }}
      closest-release: ${{ steps.find-release.outputs.closest-release }}
      latest-release: ${{ steps.find-release.outputs.latest-release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get all releases and search for PackageExporter
        id: find-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the list of all release tags up to 50
          all_releases=$(gh release list --json tagName --limit 50)
          release_tags=$(echo "$all_releases" | jq -r '.[].tagName')
          
          # Initialize variables
          latest_release=""
          closest_release=""
          
          # Iterate over the releases
          for tag in $release_tags; do
          # Get detailed release info for each tag
          release_info=$(gh release view "$tag" --json tagName,assets)
        
          # Check if this is the latest release
          if [ -z "$latest_release" ]; then
            latest_release="$tag"
            echo "latest-release=$latest_release" >> "$GITHUB_OUTPUT"
          fi
        
          # Check for matching .unitypackage in the assets
          match=$(echo "$release_info" | jq -r '.assets[].name | select(test("PackageExporter_.*\\.unitypackage"))')
          if [ -n "$match" ] && [ -z "$closest_release" ]; then
            closest_release="$tag"
            echo "Closest release found: $closest_release"
          fi
          done
          
          # Output the results
          if [ -n "$closest_release" ]; then
            echo "closest-release=$closest_release" >> "$GITHUB_OUTPUT"
          else
            echo "No matching unitypackage found."
            echo "closest-release=" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if PackageExporter exists in the latest release
        id: check-file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          latest_release: ${{ steps.find-release.outputs.latest-release }}
        run: |
          # Check if the latest release contains the unitypackage
          release_info=$(gh release view "$latest_release" --json assets)
          file_present=$(echo "$release_info" | jq '.assets[].name | select(test("PackageExporter_.*\\.unitypackage"))')
          
          if [ -n "$file_present" ]; then
            echo "Unitypackage file found in the latest release."
            echo "file-present=1" >> "$GITHUB_OUTPUT"
          else
            echo "No Unitypackage found in the latest release."
          fi

  upload-package:
    needs: check-package
    runs-on: ubuntu-22.04
    steps:
      - name: Handle PackageExporter Upload
        if: ${{ needs.check-package.outputs.file-present != '1' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          closest_release=${{ needs.check-package.outputs.closest-release }}
          latest_release=${{ needs.check-package.outputs.latest-release }}
          
          if [ -n "$closest_release" ]; then
            echo "Uploading from closest release ($closest_release) to the latest release ($latest_release)..."
          
            gh release download "$closest_release" --pattern "PackageExporter_*.unitypackage" -D ./temp-unitypackage
          
            gh release upload "$latest_release" ./temp-unitypackage/PackageExporter_*.unitypackage
            echo "Successfully uploaded the file to the latest release: $latest_release"
          else
            echo "No closest release found with a PackageExporter. Nothing to upload."
            exit 1
          fi